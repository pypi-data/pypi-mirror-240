"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([[9897],{9897:function(e,t,r){r.r(t),r.d(t,{HuiEnergyUsageGraphCard:function(){return I}});var a,o,i,s,n=r(99312),d=r(53709),c=r(68990),l=r(81043),u=r(40039),f=r(88962),h=r(33368),g=r(71650),_=r(82390),y=r(69205),v=r(70906),p=r(91808),b=r(27088),m=r(70390),k=r(53970),x=r(24112),Z=r(72277),S=r(59699),w=r(68144),O=r(79932),j=r(83448),C=r(14516),E=r(15838),M=r(89525),z=r(12198),D=r(49684),P=r(18457),A=(r(62336),r(22098),r(55424)),B=r(38014),V=r(73826),I=(0,p.Z)([(0,O.Mo)("hui-energy-usage-graph-card")],(function(e,t){var r,p=function(t){(0,y.Z)(a,t);var r=(0,v.Z)(a);function a(){var t;(0,g.Z)(this,a);for(var o=arguments.length,i=new Array(o),s=0;s<o;s++)i[s]=arguments[s];return t=r.call.apply(r,[this].concat(i)),e((0,_.Z)(t)),t}return(0,h.Z)(a)}(t);return{F:p,d:[{kind:"field",decorators:[(0,O.Cb)({attribute:!1})],key:"hass",value:void 0},{kind:"field",decorators:[(0,O.SB)()],key:"_config",value:void 0},{kind:"field",decorators:[(0,O.SB)()],key:"_chartData",value:function(){return{datasets:[]}}},{kind:"field",decorators:[(0,O.SB)()],key:"_start",value:function(){return(0,b.Z)()}},{kind:"field",decorators:[(0,O.SB)()],key:"_end",value:function(){return(0,m.Z)()}},{kind:"field",decorators:[(0,O.SB)()],key:"_compareStart",value:void 0},{kind:"field",decorators:[(0,O.SB)()],key:"_compareEnd",value:void 0},{kind:"field",key:"hassSubscribeRequiredHostProps",value:function(){return["_config"]}},{kind:"method",key:"hassSubscribe",value:function(){var e,t=this;return[(0,A.UB)(this.hass,{key:null===(e=this._config)||void 0===e?void 0:e.collection_key}).subscribe((function(e){return t._getStatistics(e)}))]}},{kind:"method",key:"getCardSize",value:function(){return 3}},{kind:"method",key:"setConfig",value:function(e){this._config=e}},{kind:"method",key:"render",value:function(){return this.hass&&this._config?(0,w.dy)(a||(a=(0,f.Z)([" <ha-card> ",' <div class="content ','"> <ha-chart-base .hass="','" .data="','" .options="','" chart-type="bar"></ha-chart-base> '," </div> </ha-card> "])),this._config.title?(0,w.dy)(o||(o=(0,f.Z)(['<h1 class="card-header">',"</h1>"])),this._config.title):"",(0,j.$)({"has-header":!!this._config.title}),this.hass,this._chartData,this._createOptions(this._start,this._end,this.hass.locale,this.hass.config,this._compareStart,this._compareEnd),this._chartData.datasets.some((function(e){return e.data.length}))?"":(0,w.dy)(i||(i=(0,f.Z)(['<div class="no-data"> '," </div>"])),(0,k.Z)(this._start)?this.hass.localize("ui.panel.lovelace.cards.energy.no_data"):this.hass.localize("ui.panel.lovelace.cards.energy.no_data_period"))):w.Ld}},{kind:"field",key:"_createOptions",value:function(){var e=this;return(0,C.Z)((function(t,r,a,o,i,s){var n=(0,x.Z)(r,t),d=void 0!==i&&void 0!==s;if(d){var c=(0,Z.Z)(r,t),l=(0,Z.Z)(s,i);l>c?r=(0,S.Z)(r,l-c):c>l&&(s=(0,S.Z)(s,c-l))}var f={parsing:!1,animation:!1,interaction:{mode:"x"},scales:{x:{type:"time",suggestedMin:t.getTime(),suggestedMax:r.getTime(),adapters:{date:{locale:a,config:o}},ticks:{maxRotation:0,sampleSize:5,autoSkipPadding:20,font:function(e){return e.tick&&e.tick.major?{weight:"bold"}:{}}},time:{tooltipFormat:n>35?"monthyear":n>7?"date":n>2?"weekday":n>0?"datetime":"hour",minUnit:n>35?"month":n>2?"day":"hour"}},y:{stacked:!0,type:"linear",title:{display:!0,text:"kWh"},ticks:{beginAtZero:!0,callback:function(e){return(0,P.uf)(Math.abs(e),a)}}}},plugins:{tooltip:{position:"nearest",filter:function(e){return"0"!==e.formattedValue},itemSort:function(e,t){var r,a,o,i,s;return(null===(r=e.raw)||void 0===r?void 0:r.y)>0&&(null===(a=t.raw)||void 0===a?void 0:a.y)<0?-1:(null===(o=t.raw)||void 0===o?void 0:o.y)>0&&(null===(i=e.raw)||void 0===i?void 0:i.y)<0?1:(null===(s=e.raw)||void 0===s?void 0:s.y)>0?t.datasetIndex-e.datasetIndex:e.datasetIndex-t.datasetIndex},callbacks:{title:function(e){if(n>0)return e[0].label;var t=new Date(e[0].parsed.x);return"".concat(d?"".concat((0,z.ud)(t,a,o),": "):"").concat((0,D.mr)(t,a,o)," â€“ ").concat((0,D.mr)((0,S.Z)(t,1),a,o))},label:function(e){return"".concat(e.dataset.label,": ").concat((0,P.uf)(Math.abs(e.parsed.y),a)," kWh")},footer:function(t){var r,o=0,i=0,s=(0,u.Z)(t);try{for(s.s();!(r=s.n()).done;){var n=r.value,d=n.dataset.data[n.dataIndex].y;d>0?o+=d:i+=Math.abs(d)}}catch(c){s.e(c)}finally{s.f()}return[o?e.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.total_consumed",{num:(0,P.uf)(o,a)}):"",i?e.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.total_returned",{num:(0,P.uf)(i,a)}):""].filter(Boolean)}}},filler:{propagate:!1},legend:{display:!1,labels:{usePointStyle:!0}}},elements:{bar:{borderWidth:1.5,borderRadius:4},point:{hitRadius:50}},locale:(0,P.Hd)(a)};return d&&(f.scales.xAxisCompare=Object.assign(Object.assign({},f.scales.x),{},{suggestedMin:i.getTime(),suggestedMax:s.getTime(),display:!1})),f}))}},{kind:"method",key:"_getStatistics",value:(r=(0,l.Z)((0,n.Z)().mark((function e(t){var r,a,o,i,s,l,f,h,g,_,y,v,p,b,k;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],a={},o=(0,u.Z)(t.prefs.energy_sources),e.prev=3,o.s();case 5:if((i=o.n()).done){e.next=21;break}if("solar"!==(s=i.value).type){e.next=10;break}return a.solar?a.solar.push(s.stat_energy_from):a.solar=[s.stat_energy_from],e.abrupt("continue",19);case 10:if("battery"!==s.type){e.next=13;break}return a.to_battery?(a.to_battery.push(s.stat_energy_to),a.from_battery.push(s.stat_energy_from)):(a.to_battery=[s.stat_energy_to],a.from_battery=[s.stat_energy_from]),e.abrupt("continue",19);case 13:if("grid"===s.type){e.next=15;break}return e.abrupt("continue",19);case 15:l=(0,u.Z)(s.flow_from);try{for(l.s();!(f=l.n()).done;)h=f.value,a.from_grid?a.from_grid.push(h.stat_energy_from):a.from_grid=[h.stat_energy_from]}catch(n){l.e(n)}finally{l.f()}g=(0,u.Z)(s.flow_to);try{for(g.s();!(_=g.n()).done;)y=_.value,a.to_grid?a.to_grid.push(y.stat_energy_to):a.to_grid=[y.stat_energy_to]}catch(n){g.e(n)}finally{g.f()}case 19:e.next=5;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(3),o.e(e.t0);case 26:return e.prev=26,o.f(),e.finish(26);case 29:v=getComputedStyle(this),p={to_grid:"--energy-grid-return-color",to_battery:"--energy-battery-in-color",from_grid:"--energy-grid-consumption-color",used_grid:"--energy-grid-consumption-color",used_solar:"--energy-solar-color",used_battery:"--energy-battery-out-color"},b={to_grid:{base:v.getPropertyValue(p.to_grid).trim()},to_battery:{base:v.getPropertyValue(p.to_battery).trim()},from_grid:{base:v.getPropertyValue(p.from_grid).trim()},used_grid:{base:v.getPropertyValue(p.used_grid).trim()},used_solar:{base:v.getPropertyValue(p.used_solar).trim()},used_battery:{base:v.getPropertyValue(p.used_battery).trim()}},Object.entries(p).forEach((function(e){var t=(0,c.Z)(e,2),r=t[0],o=t[1];"used_grid"!==r&&"used_solar"!==r&&"used_battery"!==r&&(b[r].overrides=[],a[r]&&Object.values(a[r]).forEach((function(e,t){var a=v.getPropertyValue(o+"-"+t).trim();a.length>0&&(b[r].overrides[e]=a)})))})),k={used_grid:this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.combined_from_grid"),used_solar:this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.consumed_solar"),used_battery:this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.consumed_battery")},this._start=t.start,this._end=t.end||(0,m.Z)(),this._compareStart=t.startCompare,this._compareEnd=t.endCompare,r.push.apply(r,(0,d.Z)(this._processDataSet(t.stats,t.statsMetadata,a,b,k,!1))),t.statsCompare&&(r.push({order:0,data:[]}),r.push({order:999,data:[],xAxisID:"xAxisCompare"}),r.push.apply(r,(0,d.Z)(this._processDataSet(t.statsCompare,t.statsMetadata,a,b,k,!0)))),this._chartData={datasets:r};case 41:case"end":return e.stop()}}),e,this,[[3,23,26,29]])}))),function(e){return r.apply(this,arguments)})},{kind:"method",key:"_processDataSet",value:function(e,t,r,a,o){var i,s=this,n=arguments.length>5&&void 0!==arguments[5]&&arguments[5],d=[],l={},u={};Object.entries(r).forEach((function(t){var r=(0,c.Z)(t,2),a=r[0],o=r[1],s=["solar","to_grid","from_grid","to_battery","from_battery"].includes(a),n=!["solar","from_battery"].includes(a),d={},f={};o.forEach((function(t){var r=e[t];if(r){var a={};r.forEach((function(e){if(null!==e.change&&void 0!==e.change){var t=e.change;s&&(d[e.start]=e.start in d?d[e.start]+t:t,i=e.end),n&&!(e.start in a)&&(a[e.start]=t,i=e.end)}})),f[t]=a}})),s&&(u[a]=d),n&&(l[a]=f)}));var f={},h={};if((u.to_grid||u.to_battery)&&u.solar){for(var g={},_=0,y=Object.keys(u.solar);_<y.length;_++){var v,p,b=y[_];if(g[b]=(u.solar[b]||0)-((null===(v=u.to_grid)||void 0===v?void 0:v[b])||0)-((null===(p=u.to_battery)||void 0===p?void 0:p[b])||0),g[b]<0){var m,k,x;if(u.to_battery)if(f[b]=-1*g[b],f[b]>((null===(m=u.from_grid)||void 0===m?void 0:m[b])||0))h[b]=Math.min(0,f[b]-((null===(k=u.from_grid)||void 0===k?void 0:k[b])||0)),f[b]=null===(x=u.from_grid)||void 0===x?void 0:x[b];g[b]=0}}l.used_solar={used_solar:g}}if(u.from_battery)if(u.to_grid){for(var Z={},S=0,w=Object.keys(u.from_battery);S<w.length;S++){var O=w[S];Z[O]=(u.from_battery[O]||0)-(h[O]||0)}l.used_battery={used_battery:Z}}else l.used_battery={used_battery:u.from_battery};if(l.from_grid&&u.to_battery){for(var j={},C=function(){for(var e,t=D[z],r=0,a=0,o=Object.entries(l.from_grid);a<o.length;a++){var i=(0,c.Z)(o[a],2),s=i[0];if(i[1][t]&&(e=s,r++),r>1)break}if(1===r)l.from_grid[e][t]-=f[t]||0;else{var n=0;Object.values(l.from_grid).forEach((function(e){n+=e[t]||0,delete e[t]})),j[t]=n-(f[t]||0)}},z=0,D=Object.keys(f);z<D.length;z++)C();l.used_grid={used_grid:j}}var P=[];Object.values(l).forEach((function(e){Object.values(e).forEach((function(e){P=P.concat(Object.keys(e))}))}));var A=Array.from(new Set(P));return Object.entries(l).forEach((function(e){var r=(0,c.Z)(e,2),u=r[0],f=r[1];Object.entries(f).forEach((function(e,r){var f,h=(0,c.Z)(e,2),g=h[0],_=h[1],y=null===(f=a[u].overrides)||void 0===f?void 0:f[g];if(!y){var v=r>0?s.hass.themes.darkMode?(0,M.C)((0,E.Rw)((0,E.wK)(a[u].base)),r):(0,M.W)((0,E.Rw)((0,E.wK)(a[u].base)),r):void 0;y=v?(0,E.CO)((0,E.p3)(v)):a[u].base}for(var p=[],b=0,m=A;b<m.length;b++){var k=m[b],x=_[k]||0;p.push({x:Number(k),y:x&&["to_grid","to_battery"].includes(u)?-1*x:x})}1===p.length&&p.push({x:i,y:0}),d.push({label:u in o?o[u]:(0,B.Kd)(s.hass,g,t[g]),order:"used_solar"===u?1:"to_battery"===u?Object.keys(l).length:r+2,borderColor:n?y+"7F":y,backgroundColor:n?y+"32":y+"7F",stack:"stack",data:p,xAxisID:n?"xAxisCompare":void 0})}))})),d}},{kind:"get",static:!0,key:"styles",value:function(){return(0,w.iv)(s||(s=(0,f.Z)(["ha-card{height:100%}.card-header{padding-bottom:0}.content{padding:16px}.has-header{padding-top:0}.no-data{position:absolute;height:100%;top:0;left:0;right:0;display:flex;justify-content:center;align-items:center;padding:20%;margin-left:32px;box-sizing:border-box}"])))}}]}}),(0,V.f)(w.oi))}}]);
//# sourceMappingURL=9897-cy3PauYW0Y4.js.map
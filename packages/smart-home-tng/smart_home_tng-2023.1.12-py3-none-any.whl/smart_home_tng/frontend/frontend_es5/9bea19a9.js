"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([[66054],{23682:function(e,t,n){function r(e,t){if(t.length<e)throw new TypeError(e+" argument"+(e>1?"s":"")+" required, but only "+t.length+" present")}n.d(t,{Z:function(){return r}})},90394:function(e,t,n){function r(e){if(null===e||!0===e||!1===e)return NaN;var t=Number(e);return isNaN(t)?t:t<0?Math.ceil(t):Math.floor(t)}n.d(t,{Z:function(){return r}})},79021:function(e,t,n){n.d(t,{Z:function(){return i}});var r=n(90394),o=n(34327),s=n(23682);function i(e,t){(0,s.Z)(2,arguments);var n=(0,o.Z)(e),i=(0,r.Z)(t);return isNaN(i)?new Date(NaN):i?(n.setDate(n.getDate()+i),n):n}},59699:function(e,t,n){n.d(t,{Z:function(){return a}});var r=n(90394),o=n(39244),s=n(23682),i=36e5;function a(e,t){(0,s.Z)(2,arguments);var n=(0,r.Z)(t);return(0,o.Z)(e,n*i)}},39244:function(e,t,n){n.d(t,{Z:function(){return i}});var r=n(90394),o=n(34327),s=n(23682);function i(e,t){(0,s.Z)(2,arguments);var n=(0,o.Z)(e).getTime(),i=(0,r.Z)(t);return new Date(n+i)}},32182:function(e,t,n){n.d(t,{Z:function(){return i}});var r=n(90394),o=n(34327),s=n(23682);function i(e,t){(0,s.Z)(2,arguments);var n=(0,o.Z)(e),i=(0,r.Z)(t);if(isNaN(i))return new Date(NaN);if(!i)return n;var a=n.getDate(),u=new Date(n.getTime());return u.setMonth(n.getMonth()+i+1,0),a>=u.getDate()?u:(n.setFullYear(u.getFullYear(),u.getMonth(),a),n)}},4535:function(e,t,n){n.d(t,{Z:function(){return c}});var r=n(34327);function o(e){var t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()));return t.setUTCFullYear(e.getFullYear()),e.getTime()-t.getTime()}var s=n(59429),i=n(23682),a=864e5;function u(e,t){var n=e.getFullYear()-t.getFullYear()||e.getMonth()-t.getMonth()||e.getDate()-t.getDate()||e.getHours()-t.getHours()||e.getMinutes()-t.getMinutes()||e.getSeconds()-t.getSeconds()||e.getMilliseconds()-t.getMilliseconds();return n<0?-1:n>0?1:n}function c(e,t){(0,i.Z)(2,arguments);var n=(0,r.Z)(e),c=(0,r.Z)(t),l=u(n,c),f=Math.abs(function(e,t){(0,i.Z)(2,arguments);var n=(0,s.Z)(e),r=(0,s.Z)(t),u=n.getTime()-o(n),c=r.getTime()-o(r);return Math.round((u-c)/a)}(n,c));n.setDate(n.getDate()-l*f);var _=l*(f-Number(u(n,c)===-l));return 0===_?0:_}},93752:function(e,t,n){n.d(t,{Z:function(){return s}});var r=n(34327),o=n(23682);function s(e){(0,o.Z)(1,arguments);var t=(0,r.Z)(e);return t.setHours(23,59,59,999),t}},70390:function(e,t,n){n.d(t,{Z:function(){return o}});var r=n(93752);function o(){return(0,r.Z)(Date.now())}},47538:function(e,t,n){function r(){var e=new Date,t=e.getFullYear(),n=e.getMonth(),r=e.getDate(),o=new Date(0);return o.setFullYear(t,n,r-1),o.setHours(23,59,59,999),o}n.d(t,{Z:function(){return r}})},59429:function(e,t,n){n.d(t,{Z:function(){return s}});var r=n(34327),o=n(23682);function s(e){(0,o.Z)(1,arguments);var t=(0,r.Z)(e);return t.setHours(0,0,0,0),t}},27088:function(e,t,n){n.d(t,{Z:function(){return o}});var r=n(59429);function o(){return(0,r.Z)(Date.now())}},83008:function(e,t,n){function r(){var e=new Date,t=e.getFullYear(),n=e.getMonth(),r=e.getDate(),o=new Date(0);return o.setFullYear(t,n,r-1),o.setHours(0,0,0,0),o}n.d(t,{Z:function(){return r}})},34327:function(e,t,n){n.d(t,{Z:function(){return s}});var r=n(76775),o=n(23682);function s(e){(0,o.Z)(1,arguments);var t=Object.prototype.toString.call(e);return e instanceof Date||"object"===(0,r.Z)(e)&&"[object Date]"===t?new Date(e.getTime()):"number"==typeof e||"[object Number]"===t?new Date(e):("string"!=typeof e&&"[object String]"!==t||"undefined"==typeof console||(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://github.com/date-fns/date-fns/blob/master/docs/upgradeGuide.md#string-arguments"),console.warn((new Error).stack)),new Date(NaN))}},92306:function(e,t,n){n.d(t,{v:function(){return r}});const r=(e,t)=>{const n={};for(const r of e){const e=t(r);e in n?n[e].push(r):n[e]=[r]}return n}},11950:function(e,t,n){n.d(t,{l:function(){return r}});const r=async(e,t)=>new Promise((n=>{const r=t(e,(e=>{r(),n(e)}))}))},81582:function(e,t,n){n.d(t,{LZ:function(){return r},Nn:function(){return u},Ny:function(){return c},Q4:function(){return o},SO:function(){return i},T0:function(){return l},iJ:function(){return a},pB:function(){return s}});const r=32143==n.j?["migration_error","setup_error","setup_retry"]:null,o=32143==n.j?["not_loaded","loaded","setup_error","setup_retry"]:null,s=(e,t)=>{const n={};return t&&(t.type&&(n.type_filter=t.type),t.domain&&(n.domain=t.domain)),e.callWS(Object.assign({type:"config_entries/get"},n))},i=(e,t,n)=>e.callWS(Object.assign({type:"config_entries/update",entry_id:t},n)),a=(e,t)=>e.callApi("DELETE",`config/config_entries/entry/${t}`),u=(e,t)=>e.callApi("POST",`config/config_entries/entry/${t}/reload`),c=(e,t)=>e.callWS({type:"config_entries/disable",entry_id:t,disabled_by:"user"}),l=(e,t)=>e.callWS({type:"config_entries/disable",entry_id:t,disabled_by:null})},55424:function(e,t,n){n.d(t,{Bm:function(){return v},Jj:function(){return O},KU:function(){return D},P:function(){return T},UB:function(){return H},ZC:function(){return N},_Z:function(){return W},_n:function(){return I},gM:function(){return Y},gy:function(){return j},iK:function(){return Z},jB:function(){return F},o1:function(){return w},rl:function(){return S},vE:function(){return B},vR:function(){return L},xZ:function(){return k},yH:function(){return E},yT:function(){return z}});var r=n(4535),o=n(59699),s=n(32182),i=n(79021),a=n(39244),u=n(27088),c=n(83008),l=n(70390),f=n(47538),_=n(97330),y=n(92306),g=n(11950),d=n(81582),p=n(74186),m=n(38014);function h(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const b=[],v=()=>({stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),w=()=>({stat_energy_to:"",stat_compensation:null,entity_energy_price:null,number_energy_price:null}),Z=()=>({type:"grid",flow_from:[],flow_to:[],cost_adjustment_day:0}),S=()=>({type:"solar",stat_energy_from:"",config_entry_solar_forecast:null}),T=()=>({type:"battery",stat_energy_from:"",stat_energy_to:""}),D=()=>({type:"gas",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),k=e=>e.callWS({type:"energy/info"}),j=e=>e.callWS({type:"energy/validate"});class M extends Error{constructor(e){super(e),h(this,"code","not_found"),Object.setPrototypeOf(this,new.target.prototype)}}const N=async(e,t=!1)=>{const n=await e.callWS({type:"energy/get_prefs"});if(t){const e=n.energy_sources.length>0,t=n.device_consumption.length>0;if(!e&&!t)throw new M}return n},W=async(e,t)=>{const n=e.callWS(Object.assign({type:"energy/save_prefs"},t));return C(e),n},P=async(e,t,n,r,o,s="hour")=>e.callWS({type:"energy/fossil_energy_consumption",start_time:t.toISOString(),end_time:null==o?void 0:o.toISOString(),energy_statistic_ids:n,co2_statistic_id:r,period:s}),O=e=>(0,y.v)(e.energy_sources,(e=>e.type)),E=(e,t)=>{const n=[];for(const r of e.energy_sources)if("solar"!==r.type)if("gas"!==r.type)if("battery"!==r.type){for(const e of r.flow_from){n.push(e.stat_energy_from),e.stat_cost&&n.push(e.stat_cost);const r=t.cost_sensors[e.stat_energy_from];r&&n.push(r)}for(const e of r.flow_to){n.push(e.stat_energy_to),e.stat_compensation&&n.push(e.stat_compensation);const r=t.cost_sensors[e.stat_energy_to];r&&n.push(r)}}else n.push(r.stat_energy_from),n.push(r.stat_energy_to);else{n.push(r.stat_energy_from),r.stat_cost&&n.push(r.stat_cost);const e=t.cost_sensors[r.stat_energy_from];e&&n.push(e)}else n.push(r.stat_energy_from);for(const r of e.device_consumption)n.push(r.stat_consumption);return n},C=e=>{b.forEach((t=>{const n=H(e,{key:t});n.clearPrefs(),n._active&&n.refresh()}))},H=(e,t={})=>{let n="_energy";if(t.key){if(!t.key.startsWith("energy_"))throw new Error("Key need to start with energy_");n=`_${t.key}`}if(e.connection[n])return e.connection[n];b.push(t.key);const y=(0,_._)(e.connection,n,(async()=>{if(y.prefs||(y.prefs=await N(e,!0)),y._refreshTimeout&&clearTimeout(y._refreshTimeout),y._active&&(!y.end||y.end>new Date)){const e=new Date;e.getMinutes()>=20&&e.setHours(e.getHours()+1),e.setMinutes(20,0,0),y._refreshTimeout=window.setTimeout((()=>y.refresh()),e.getTime()-Date.now())}return(async(e,t,n,u,c)=>{const[l,f,_]=await Promise.all([(0,d.pB)(e,{domain:"co2signal"}),(0,g.l)(e.connection,p.LM),k(e)]),y=l.length?l[0]:void 0;let h;if(y)for(const r of f){if(r.config_entry_id!==y.entry_id)continue;const t=e.states[r.entity_id];if(t&&"%"===t.attributes.unit_of_measurement){h=t.entity_id;break}}const b=[];for(const r of t.energy_sources)if("grid"===r.type)for(const e of r.flow_from)b.push(e.stat_energy_from);const v=E(t,_),w=(0,r.Z)(u||new Date,n),Z=w>35?"month":w>2?"day":"hour",S=(0,o.Z)(n,-1),T={energy:"kWh",volume:"km"===(e.config.unit_system.length||"")?"m³":"ft³"},D=await(0,m.dL)(e,S,u,v,Z,T);let j,M,N,W,O;if(c){M=w>27&&w<32?(0,s.Z)(n,-1):(0,i.Z)(n,-1*(w+1));const t=(0,o.Z)(M,-1);N=(0,a.Z)(n,-1),j=await(0,m.dL)(e,t,N,v,Z,T)}void 0!==h&&(W=await P(e,n,b,h,u,w>35?"month":w>2?"day":"hour"),c&&(O=await P(e,M,b,h,N,w>35?"month":w>2?"day":"hour"))),Object.values(D).forEach((e=>{e.length&&new Date(e[0].start)>S&&e.unshift(Object.assign({},e[0],{start:S.toISOString(),end:S.toISOString(),sum:0,state:0}))}));const C=await(0,m.Py)(e,v),H={};return C.forEach((e=>{H[e.statistic_id]=e})),{start:n,end:u,startCompare:M,endCompare:N,info:_,prefs:t,stats:D,statsMetadata:H,statsCompare:j,co2SignalConfigEntry:y,co2SignalEntity:h,fossilEnergyConsumption:W,fossilEnergyConsumptionCompare:O}})(e,y.prefs,y.start,y.end,y.compare)})),h=y.subscribe;y.subscribe=e=>{const t=h(e);return y._active++,()=>{y._active--,y._active<1&&(clearTimeout(y._refreshTimeout),y._refreshTimeout=void 0),t()}},y._active=0,y.prefs=t.prefs;const v=new Date;y.start=v.getHours()>0?(0,u.Z)():(0,c.Z)(),y.end=v.getHours()>0?(0,l.Z)():(0,f.Z)();const w=()=>{y._updatePeriodTimeout=window.setTimeout((()=>{y.start=(0,u.Z)(),y.end=(0,l.Z)(),w()}),(0,o.Z)((0,l.Z)(),1).getTime()-Date.now())};return w(),y.clearPrefs=()=>{y.prefs=void 0},y.setPeriod=(e,t)=>{var n;y.start=e,y.end=t,y.start.getTime()!==(0,u.Z)().getTime()||(null===(n=y.end)||void 0===n?void 0:n.getTime())!==(0,l.Z)().getTime()||y._updatePeriodTimeout?y._updatePeriodTimeout&&(clearTimeout(y._updatePeriodTimeout),y._updatePeriodTimeout=void 0):w()},y.setCompare=e=>{y.compare=e},y},F=e=>e.callWS({type:"energy/solar_forecast"}),Y=["m³"],z=["kWh"],I=[...Y,...z],L=(e,t={},n)=>{for(const r of e.energy_sources){if("gas"!==r.type)continue;if(n&&n===r.stat_energy_from)continue;const e=t[r.stat_energy_from];if(e)return Y.includes(e.statistics_unit_of_measurement)?"volume":"energy"}},B=(e,t={})=>{for(const n of e.energy_sources){if("gas"!==n.type)continue;const e=t[n.stat_energy_from];if(null!=e&&e.display_unit_of_measurement)return e.display_unit_of_measurement}}},38014:function(e,t,n){n.d(t,{Cj:function(){return u},Kd:function(){return d},Kj:function(){return f},Nw:function(){return y},Py:function(){return s},ZT:function(){return c},dL:function(){return i},hN:function(){return l},h_:function(){return a},j2:function(){return g},q6:function(){return _},uR:function(){return o}});var r=n(91741);const o=(e,t)=>e.callWS({type:"recorder/list_statistic_ids",statistic_type:t}),s=(e,t)=>e.callWS({type:"recorder/get_statistics_metadata",statistic_ids:t}),i=(e,t,n,r,o="hour",s)=>e.callWS({type:"recorder/statistics_during_period",start_time:t.toISOString(),end_time:null==n?void 0:n.toISOString(),statistic_ids:r,period:o,units:s}),a=e=>e.callWS({type:"recorder/validate_statistics"}),u=(e,t,n)=>e.callWS({type:"recorder/update_statistics_metadata",statistic_id:t,unit_of_measurement:n}),c=(e,t,n,r)=>e.callWS({type:"recorder/change_statistics_unit",statistic_id:t,old_unit_of_measurement:n,new_unit_of_measurement:r}),l=(e,t)=>e.callWS({type:"recorder/clear_statistics",statistic_ids:t}),f=e=>{if(!e||e.length<2)return null;const t=e[e.length-1].sum;if(null===t)return null;const n=e[0].sum;return null===n?t:t-n},_=(e,t)=>{let n=null;for(const r of t){if(!(r in e))continue;const t=f(e[r]);null!==t&&(null===n?n=t:n+=t)}return n},y=(e,t)=>e.some((e=>null!==e[t])),g=(e,t,n,r,o)=>e.callWS({type:"recorder/adjust_sum_statistics",statistic_id:t,start_time:n,adjustment:r,display_unit:o}),d=(e,t,n)=>{const o=e.states[t];return o?(0,r.C)(o):(null==n?void 0:n.name)||t}},66054:function(e,t,n){n.r(t),n.d(t,{EnergyStrategy:function(){return o}});var r=n(55424);class o{static async generateView(e){const t=e.hass,o={cards:[]};let s;try{s=await(0,r.ZC)(t,!0)}catch(l){return"not_found"===l.code?(async()=>(await Promise.all([n.e(878),n.e(88369)]).then(n.bind(n,55158)),{type:"panel",cards:[{type:"custom:energy-setup-wizard-card"}]}))():(o.cards.push({type:"markdown",content:`An error occurred while fetching your energy preferences: ${l.message}.`}),o)}o.type="sidebar";const i=s.energy_sources.find((e=>"grid"===e.type)),a=i&&i.flow_to.length,u=s.energy_sources.some((e=>"solar"===e.type)),c=s.energy_sources.some((e=>"gas"===e.type));return e.narrow&&o.cards.push({type:"energy-date-selection",collection_key:"energy_dashboard",view_layout:{position:"sidebar"}}),o.cards.push({type:"energy-compare",collection_key:"energy_dashboard"}),i&&o.cards.push({title:t.localize("ui.panel.energy.cards.energy_usage_graph_title"),type:"energy-usage-graph",collection_key:"energy_dashboard"}),u&&o.cards.push({title:t.localize("ui.panel.energy.cards.energy_solar_graph_title"),type:"energy-solar-graph",collection_key:"energy_dashboard"}),c&&o.cards.push({title:t.localize("ui.panel.energy.cards.energy_gas_graph_title"),type:"energy-gas-graph",collection_key:"energy_dashboard"}),i&&o.cards.push({title:t.localize("ui.panel.energy.cards.energy_distribution_title"),type:"energy-distribution",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),(i||u)&&o.cards.push({title:t.localize("ui.panel.energy.cards.energy_sources_table_title"),type:"energy-sources-table",collection_key:"energy_dashboard"}),a&&o.cards.push({type:"energy-grid-neutrality-gauge",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),u&&a&&o.cards.push({type:"energy-solar-consumed-gauge",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),i&&o.cards.push({type:"energy-carbon-consumed-gauge",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),s.device_consumption.length&&o.cards.push({title:t.localize("ui.panel.energy.cards.energy_devices_graph_title"),type:"energy-devices-graph",collection_key:"energy_dashboard"}),o}}},76775:function(e,t,n){function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}n.d(t,{Z:function(){return r}})}}]);
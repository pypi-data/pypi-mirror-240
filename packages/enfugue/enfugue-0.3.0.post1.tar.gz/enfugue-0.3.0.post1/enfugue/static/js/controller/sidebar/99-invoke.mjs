import{isEmpty}from"../../base/helpers.mjs";import{ElementBuilder}from"../../base/builder.mjs";import{ButtonInputView}from"../../forms/input.mjs";import{Controller}from"../base.mjs";import{View}from"../../view/base.mjs";const E=new ElementBuilder;class InvokeLoadingBarView extends View{static className="invoke-loader";static loaderClassName="loading-bar"}class EnfugueButton extends ButtonInputView{static className="invoke";static defaultValue="ENFUGUE"}class InvokeButtonController extends Controller{getLayers(){let e=this.application.layers.getState();return console.log(e),e.layers.map(((e,t)=>{let i={x:e.x,y:e.y,w:e.w,h:e.h,remove_background:e.removeBackground,image:e.src};switch(e.classname){case"ImageEditorScribbleNodeView":i.control_units=[{process:!1,controlnet:"scribble"}];break;case"ImageEditorImageNodeView":case"ImageEditorVideoNodeView":i.fit=e.fit,i.anchor=e.anchor,i.denoise=!!e.denoise,e.imagePrompt&&(i.ip_adapter_scale=e.imagePromptScale),e.control&&(i.control_units=e.controlnetUnits.map((e=>({process:e.processControlImage,start:e.conditioningStart,end:e.conditioningEnd,scale:e.conditioningScale,controlnet:e.controlnet})))),isEmpty(e.skipFrames)||(i.skip_frames=e.skipFrames),isEmpty(e.divideFrames)||(i.divide_frames=e.divideFrames);break;default:throw`Unknown classname ${e.classname}`}return i}))}async tryInvoke(){this.isInvoking=!0,this.loadingBar.loading(),this.invokeButton.disable().addClass("sliding-gradient");try{this.application.autosave(),await this.application.invoke({layers:this.getLayers()})}catch(e){console.error(e);let t=`${e}`;if(isEmpty(e.detail)?isEmpty(e.title)||(t=e.title):t=e.detail,-1!==t.toLowerCase().indexOf("engine process died"))return this.notify("warn","Engine Didn't Start","The diffusion engine process exited before it started responding to requests. Waiting a moment and trying again."),await this.tryInvoke();this.notify("error","Couldn't Start",t)}this.invokeButton.enable().removeClass("sliding-gradient"),this.loadingBar.doneLoading(),this.application.autosave(),this.isInvoking=!1}async initialize(){this.invokeButton=new EnfugueButton(this.config),this.invokeButton.onChange((()=>this.tryInvoke())),this.loadingBar=new InvokeLoadingBarView,await this.application.sidebar.addChild(this.invokeButton),await this.application.sidebar.addChild(this.loadingBar),this.subscribe("tryInvoke",(()=>{!0!==this.isInvoking&&this.tryInvoke()}))}}export{InvokeButtonController as SidebarController};

import{ImageInspectorView}from"../../view/image.mjs";import{isEmpty,isEquivalent,waitFor,humanDuration}from"../../base/helpers.mjs";import{ElementBuilder}from"../../base/builder.mjs";import{Controller}from"../base.mjs";const E=new ElementBuilder({invocationTask:"enfugue-invocation-task",invocationLoading:"enfugue-invocation-loading",invocationLoaded:"enfugue-invocation-loaded",invocationDuration:"enfugue-invocation-duration",invocationIterations:"enfugue-invocation-iterations",invocationRemaining:"enfugue-invocation-remaining",engineStop:"enfugue-engine-stop"});class InvocationController extends Controller{static truncatePromptLength=36;constructor(e){super(e),this.kwargs={}}get width(){return this.kwargs.width||this.application.config.model.invocation.width}set width(e){this.width!==e&&this.publish("engineWidthChange",e),this.kwargs.width=e}get height(){return this.kwargs.height||this.application.config.model.invocation.height}set height(e){this.height!==e&&this.publish("engineHeightChange",e),this.kwargs.height=e}get tilingSize(){return this.kwargs.tiling_size||null}set tilingSize(e){this.tilingSize!==e&&this.publish("engineTilingSizeChange",e),this.kwargs.tiling_size=e}get tilingStride(){return this.kwargs.tiling_stride||this.application.config.model.invocation.tilingStride}set tilingStride(e){this.tilingStride!==e&&this.publish("engineTilingStrideChange",e),this.kwargs.tiling_stride=e}get tilingMaskType(){return this.kwargs.tiling_mask_type||null}set tilingMaskType(e){this.tilingMaskType!==e&&this.publish("engineTilingMaskTypeChange",e),this.kwargs.tiling_mask_type=e}get prompt(){return this.kwargs.prompt||""}get prompt2(){return this.kwargs.prompt_2||""}set prompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.prompt!==i&&this.publish("enginePromptChange",i),this.prompt2!==t&&this.publish("enginePrompt2Change",t),this.kwargs.prompt=i,this.kwargs.prompt_2=t}get negativePrompt(){return this.kwargs.negative_prompt||""}get negativePrompt2(){return this.kwargs.negative_prompt_2||""}set negativePrompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.negativePrompt!==i&&this.publish("engineNegativePromptChange",i),this.negativePrompt2!==t&&this.publish("engineNegativePrompt2Change",t),this.kwargs.negative_prompt=i,this.kwargs.negative_prompt_2=t}get prompts(){return this.kwargs.prompts||[]}set prompts(e){isEmpty(e)&&(e=[]),e=e.map((e=>{let i={start:e.start,end:e.end,weight:e.weight};return Array.isArray(e.positive)?(i.positive=e.positive[0],i.positive_2=e.positive[1]):i.positive=e.positive,Array.isArray(e.negative)?(i.negative=e.negative[0],i.negative_2=e.negative[1]):i.negative=e.negative,i})),isEquivalent(this.prompts,e)||this.publish("enginePrompsChange",e),this.kwargs.prompts=e}get samples(){return this.kwargs.samples||1}set samples(e){this.samples!==e&&this.publish("engineSamplesChange",e),this.kwargs.samples=e}get iterations(){return this.kwargs.iterations||1}set iterations(e){this.iterations!==e&&this.publish("engineIterationsChange",e),this.kwargs.iterations=e}get seed(){return this.kwargs.seed}set seed(e){this.seed!==e&&this.publish("engineSeedChange",e),this.kwargs.seed=e}get guidanceScale(){return this.kwargs.guidance_scale||this.application.config.model.invocation.guidanceScale}set guidanceScale(e){this.guidanceScale!==e&&this.publish("engineGuidanceScaleChange",e),this.kwargs.guidance_scale=e}get inferenceSteps(){return this.kwargs.num_inference_steps||this.application.config.model.invocation.inferenceSteps}set inferenceSteps(e){this.inferenceSteps!==e&&this.publish("engineInferenceStepsChange",e),this.kwargs.num_inference_steps=e}get strength(){return this.kwargs.strength||1}set strength(e){this.strength!==e&&this.publish("engineStrengthChange",e),this.kwargs.strength=e}get mask(){return this.kwargs.mask||null}set mask(e){this.publish("engineMaskChange",e),this.kwargs.mask=e}set inferenceSteps(e){this.inferenceSteps!==e&&this.publish("engineInferenceStepsChange",e),this.kwargs.num_inference_steps=e}get model(){return this.kwargs.model}set model(e){this.model!==e&&this.publish("engineModelChange",e),this.kwargs.model=e}get modelType(){return this.kwargs.model_type||"checkpoint"}set modelType(e){this.modelType!==e&&this.publish("engineModelTypeChange",e),this.kwargs.model_type=e}get upscaleSteps(){return this.kwargs.upscale||null}get ipAdapterModel(){return this.kwargs.ip_adapter_model||null}set ipAdapterModel(e){this.ipAdapterModel!==e&&this.publish("engineIpAdapterModelChange",e),this.kwargs.ip_adapter_model=e}set upscaleSteps(e){let i=[];for(let t of e){let e={};isEmpty(t.prompt)||(Array.isArray(t.prompt)?(e.prompt=t.prompt[0],e.prompt_2=t.prompt[1]):e.prompt=t.prompt),isEmpty(t.negativePrompt)||(Array.isArray(t.negativePrompt)?(e.negative_prompt=t.negativePrompt[0],e.negative_prompt_2=t.negativePrompt[1]):e.negative_prompt=t.negativePrompt);for(let i of["strength","method","amount","scheduler"])isEmpty(t[i])||(e[i]=t[i]);isEmpty(t.inferenceSteps)||(e.num_inference_steps=t.inferenceSteps),isEmpty(t.guidanceScale)||(e.guidance_scale=t.guidanceScale),isEmpty(t.tilingStride)||(e.tiling_stride=t.tilingStride),isEmpty(t.tilingMaskType)||(e.tiling_mask_type=t.tilingMaskType),isEmpty(t.controlnet)||(e.controlnets=[t.controlnet]),isEmpty(t.pipeline)||(e.refiner="base"!==t.pipeline),isEmpty(t.noiseOffset)||(e.noise_offset=t.noiseOffset),isEmpty(t.noiseMethod)||(e.noise_method=t.noiseMethod),isEmpty(t.noiseBlendMethod)||(e.noise_blend_method=t.noiseBlendMethod),i.push(e)}isEquivalent(this.upscaleSteps,i)||this.publish("engineUpscaleStepsChange",i),this.kwargs.upscale=i}get inversion(){return this.kwargs.inversion||[]}set inversion(e){isEquivalent(this.inversion,e)||this.publish("engineInversionChange",e),this.kwargs.inversion=e}get lora(){return this.kwargs.lora||[]}set lora(e){isEquivalent(this.lora,e)||this.publish("engineLoraChange",e),this.kwargs.lora=e}get lycoris(){return this.kwargs.lycoris||[]}set lycoris(e){isEquivalent(this.lycoris,e)||this.publish("engineLycorisChange",e),this.kwargs.lycoris=e}get refiner(){return this.kwargs.refiner||null}set refiner(e){this.refiner!==e&&this.publish("engineRefinerChange",e),this.kwargs.refiner=e}get refinerSize(){return this.kwargs.refiner_size||null}set refinerSize(e){this.refinerSize!==e&&this.publish("engineRefinerSizeChange",e),this.kwargs.refiner_size=e}get refinerVae(){return this.kwargs.refiner_vae||null}set refinerVae(e){this.refinerVae!==e&&this.publish("engineRefinerVaeChange",e),this.kwargs.refiner_vae=e}get refinerPrompt(){return this.kwargs.refiner_prompt||null}get refinerPrompt2(){return this.kwargs.refiner_prompt_2||null}set refinerPrompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.refinerPrompt!==i&&this.publish("engineRefinerPromptChange",i),this.refinerPrompt2!==t&&this.publish("engineRefinerPrompt2Change",t),this.kwargs.refiner_prompt=i,this.kwargs.refiner_prompt_2=t}get refinerNegativePrompt(){return this.kwargs.refiner_negative_prompt||null}get refinerNegativePrompt2(){return this.kwargs.refiner_negative_prompt_2||null}set refinerNegativePrompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.refinerNegativePrompt!==i&&this.publish("engineRefinerNegativePromptChange",i),this.refinerNegativePrompt2!==t&&this.publish("engineRefinerNegativePrompt2Change",t),this.kwargs.refiner_negative_prompt=i,this.kwargs.refiner_negative_prompt_2=t}get refinerStart(){return this.kwargs.refiner_start||.85}set refinerStart(e){this.refinerStart!==e&&this.publish("engineRefinerStartChange",e),this.kwargs.refiner_start=e}get refinerStrength(){return this.kwargs.refiner_strength||.3}set refinerStrength(e){this.refinerStrength!==e&&this.publish("engineRefinerStrengthChange",e),this.kwargs.refiner_strength=e}get refinerGuidanceScale(){return this.kwargs.refiner_guidance_scale||5}set refinerGuidanceScale(e){this.refinerGuidanceScale!==e&&this.publish("engineRefinerGuidanceScaleChange",e),this.kwargs.refiner_guidance_scale=e}get refinerAestheticScore(){return this.kwargs.refiner_aesthetic_score||6}set refinerAestheticScore(e){this.refinerAestheticScore!==e&&this.publish("engineAestheticScoreChange",e),this.kwargs.refiner_aesthetic_score=e}get refinerNegativeAestheticScore(){return this.kwargs.refiner_negative_aesthetic_score||2.5}set refinerNegativeAestheticScore(e){this.refinerNegativeAestheticScore!==e&&this.publish("engineNegativeAestheticScoreChange",e),this.kwargs.refiner_negative_aesthetic_score=e}get inpainter(){return this.kwargs.inpainter||null}set inpainter(e){this.inpainter!==e&&this.publish("engineInpainterChange",e),this.kwargs.inpainter=e}get inpainterVae(){return this.kwargs.inpainter_vae||null}set inpainterVae(e){this.inpainterVae!==e&&this.publish("engineInpainterVaeChange",e),this.kwargs.inpainter_vae=e}get scheduler(){return this.kwargs.scheduler||null}set scheduler(e){this.scheduler!==e&&this.publish("engineSchedulerChange",e),this.kwargs.scheduler=e}get vae(){return this.kwargs.vae||null}set vae(e){this.vae!==e&&this.publish("engineVaeChange",e),this.kwargs.vae=e}get motionModule(){return this.kwargs.motion_module||null}set motionModule(e){this.motionModule!==e&&this.publish("engineMotionModuleChange",e),this.kwargs.motion_module=e}get clipSkip(){return this.kwargs.clip_skip||null}set clipSkip(e){this.clipSkip!==e&&this.publish("engineClipSkipChange"),this.kwargs.clip_skip=e}get freeUFactors(){return this.kwargs.freeu_factors||null}set freeUFactors(e){isEquivalent(this.freeUFactors,e)||this.publish("engineFreeUFactorsChange"),this.kwargs.freeu_factors=e}get noiseOffset(){return this.kwargs.noise_offset||0}set noiseOffset(e){this.noiseOffset!==e&&this.publish("engineNoiseOffsetChange"),this.kwargs.noise_offset=e}get noiseMethod(){return this.kwargs.noise_method||"perlin"}set noiseMethod(e){this.noiseMethod!==e&&this.publish("engineNoiseMethodChange"),this.kwargs.noise_method=e}get noiseBlendMethod(){return this.kwargs.noise_blend_method||"inject"}set noiseBlendMethod(e){this.noiseBlendMethod!==e&&this.publish("engineNoiseBlendMethodChange"),this.kwargs.noise_blend_method=e}get animationFrames(){return this.kwargs.animation_frames||null}set animationFrames(e){this.animationFrames!==e&&this.publish("engineAnimationFramesChange",e),this.kwargs.animation_frames=e}get animationSize(){return this.kwargs.frame_window_size||null}set animationSize(e){this.animationSize!==e&&this.publish("engineAnimationSizeChange",e),this.kwargs.frame_window_size=e}get animationStride(){return this.kwargs.frame_window_stride||null}set animationStride(e){this.animationStride!==e&&this.publish("engineAnimationStrideChange",e),this.kwargs.frame_window_stride=e}get animationLoop(){return this.kwargs.loop||null}set animationLoop(e){this.animationLoop!==e&&this.publish("engineAnimationLoopChange",e),this.kwargs.loop=e}get animationMotionScale(){return this.kwargs.motion_scale||null}set animationMotionScale(e){this.animationMotionScale!==e&&this.publish("engineAnimationMotionScaleChange",e),this.kwargs.motion_scale=e}get animationPositionEncodingTruncateLength(){return this.kwargs.position_encoding_truncate_length||null}set animationPositionEncodingTruncateLength(e){this.animationPositionEncodingTruncateLength!==e&&this.publish("engineAnimationPositionEncodingTruncateLengthChange",e),this.kwargs.position_encoding_truncate_length=e}get animationPositionEncodingScaleLength(){return this.kwargs.position_encoding_scale_length||null}set animationPositionEncodingScaleLength(e){this.animationPositionEncodingScaleLength!==e&&this.publish("engineAnimationPositionEncodingScaleLengthChange",e),this.kwargs.position_encoding_scale_length=e}get animationInterpolation(){return this.kwargs.interpolate_frames||null}set animationInterpolation(e){isEquivalent(this.animationInterpolation,e)||this.publish("engineAnimationInterpolationChange",e),this.kwargs.interpolate_frames=e}get animationRate(){return this.kwargs.frame_rate||8}set animationRate(e){isEquivalent(this.animationRate,e)||this.publish("engineAnimationRateChange",e),this.kwargs.frame_rate=e}get tileHorizontal(){let e=this.kwargs.tile;return!isEmpty(e)&&e[0]}set tileHorizontal(e){e!==this.tileHorizontal&&this.publish("engineTileHorizontalChange",e),this.kwargs.tile=[e,this.tileVertical]}get tileVertical(){let e=this.kwargs.tile;return!isEmpty(e)&&e[1]}set tileVertical(e){e!==this.tileVertical&&this.publish("engineTileVerticalChange",e),this.kwargs.tile=[this.tileHorizontal,e]}get outpaint(){return!!isEmpty(this.kwargs.outpaint)||this.kwargs.outpaint}set outpaint(e){this.outpaint!==e&&this.publish("engineOutpaintChange",e)}async initialize(){this.loadingBar=E.invocationLoading().content(E.invocationLoaded().addClass("sliding-gradient"),E.invocationDuration(),E.invocationIterations(),E.invocationTask().hide(),E.invocationRemaining().hide()),this.engineStop=E.engineStop().content("Stop Engine").on("click",(()=>{this.stopEngine()})),this.application.container.appendChild(await this.engineStop.render()),this.application.container.appendChild(await this.loadingBar.render()),this.subscribe("engineReady",(()=>{this.enableStop()})),this.subscribe("engineBusy",(()=>{this.enableStop()})),this.subscribe("engineIdle",(()=>{this.disableStop()}))}enableStop(){this.engineStop.addClass("ready")}disableStop(){this.engineStop.removeClass("ready")}async invoke(e,i=!1){e=isEmpty(e)?{}:e;let t={...this.kwargs,...e};for(let e of Object.getOwnPropertyNames(t))"number"==typeof t[e]&&isNaN(t[e])&&delete t[e];this.config.debug&&console.log("Invoking with payload",t);let n=await this.application.model.post("invoke",null,null,t);if(this.enableStop(),!isEmpty(n.uuid))if(i){let e=t.prompt.substring(0,this.constructor.truncatePromptLength);e.length===this.constructor.truncatePromptLength&&(e+="..."),await this.startDetachedInvocationMonitor(e,n.uuid,parseInt(t.width)||512,parseInt(t.height)||512)}else this.startSample=!0,this.application.samples.resetState(),await this.canvasInvocation(n.uuid)}async stopEngine(){if(this.engineStop.hasClass("ready")&&await this.confirm("Stop engine and terminate any active invocations?"))try{await this.application.model.post("/invocation/stop"),this.disableStop(),this.notify("info","Stopped","Successfully stopped engine.")}catch(e){let i=`${e}`;isEmpty(e.detail)?isEmpty(e.title)||(i=e.title):i=e.detail,this.notify("error","Error",`Received an error when stopping. The engine may still be stopped, wait a moment and check again. ${i}`)}}setSampleImages(e){let i=!isEmpty(this.animationFrames)&&this.animationFrames>0;this.application.samples.setSamples(e,i),this.startSample&&(i?(this.application.samples.setLoop(!0),this.application.samples.setPlay(!0)):this.application.samples.setActive(0),this.startSample=!1)}setSampleVideo(e){this.application.samples.setVideo(e)}async monitorInvocation(e,i,t,n,s,a){const r=this.application.config.model.invocation.interval||1e3,o=this.application.config.model.queue.interval||5e3,h=this.application.config.model.invocation.errors.consecutive||2;void 0===t&&(t=()=>{}),void 0===i&&(i=()=>{}),void 0===s&&(s=()=>{}),void 0===a&&(a=()=>{}),void 0===n&&(n=()=>{});let g,l,p,m,c,u,d,w=(new Date).getTime(),f=async()=>{let k,v;for(let i=0;i<h;i++)try{k=await this.application.model.get(`/invocation/${e}`)}catch(e){v=e}if(isEmpty(k))return this.notify("error","Invocation Error",`${h} consecutive errors were detected communicating with the server. Please check the server logs. The last error was: ${v}`),void s();if(k.total!==p&&(isEmpty(p)||(w=(new Date).getTime()),p=k.total),k.step!==l&&(l=k.step,u=(new Date).getTime()),k.rate!==m&&(m=k.rate),k.task!==g&&(i(k.task),g=k.task),c=k.duration,!isEmpty(k.images)){let e=k.images.map((e=>`/api/invocation/${e}`)),i="completed"===k.status;t(e,i)}if(!isEmpty(k.video)){let e=`/api/invocation/${k.video}`;n(e)}if("error"===k.status)return this.notify("error","Invocation Failed",k.message),void s();if("completed"!==k.status){let e=l/(u-w),i=isEmpty(m)?e:m/1e3,t=(p-l)/(.75*i+.25*e)-((new Date).getTime()-u);isNaN(t)&&(t=1/0),a(t,l,p,m,c),d=setTimeout(f,(e=>"queued"===e.status?o:r)(k))}};f()}async canvasInvocation(e){let i,t,n,s,a,r,o,h,g,l,p,m=!1,c=!1,u=(new Date).getTime(),d=u,w=u,f=u,k=this.loadingBar.find(E.getCustomTag("invocationTask")),v=this.loadingBar.find(E.getCustomTag("invocationLoaded")),_=this.loadingBar.find(E.getCustomTag("invocationDuration")),S=this.loadingBar.find(E.getCustomTag("invocationIterations")),y=this.loadingBar.find(E.getCustomTag("invocationRemaining")),b=()=>this.setSampleImages(r),C=()=>{let e=(new Date).getTime();if(c)s<100&&s>0?s+=1:(s=100,m=!0);else if(!isEmpty(t)&&t<1/0){let r=e-w,o=t-(e-n),h=r+o;a=o,i=h,s=r/h*100}d=e,(()=>{let e=d-u;if(_.content(humanDuration(e/1e3)),isEmpty(s))v.css("width","100%"),S.hide(),y.show().content("Initializing…");else if(s<100){y.show().content(humanDuration(a/1e3)),v.css("width",`${s.toFixed(2)}%`);let e=g,i="it/s";!isEmpty(e)&&e<1/0&&0!==e?(e<1&&(e=1/e,i="s/it"),S.show().content(`Iteration ${o}/${h} (${e.toFixed(2)} ${i})`)):S.show().content(`Iteration ${o}/${h}`)}else if(m||isEmpty(l))v.css("width","0"),y.empty().hide();else{y.content("Finalizing step…");let e=h/l,i="it/s";e<1&&(e=1/e,i="s/it"),S.content(`${h} Iterations at ${e.toFixed(2)} ${i}`),v.css("width","100%")}})(),m||requestAnimationFrame((()=>C()))};this.loadingBar.addClass("loading"),window.requestAnimationFrame((()=>C())),this.monitorInvocation(e,(e=>{p=e,isEmpty(e)?k.empty().hide():k.content(e).show()}),(async(e,i)=>{c=i,e.length>0&&(r=e,b())}),(async e=>{this.setSampleVideo(e)}),(()=>{c=!0,m=!0,y.empty().hide(),S.empty().hide(),k.empty().hide()}),((e,i,a,r,p)=>{t=e,o!==i&&(f=n),o=i,g=r,l=p,n=(new Date).getTime(),h!==a&&(w=n,isEmpty(h)||(o=0,s=null,f=n)),h=a})),await waitFor((()=>m)),k.empty().hide(),this.loadingBar.removeClass("loading")}async startDetachedInvocationMonitor(e,i,t,n){let s=!1,a=[],r=[];this.monitorInvocation(i,(async(o,h,g)=>{s=!0;for(let s in o){let h=o[s];if(a.length<=s){let o=new ImageInspectorView(this.application.config,h,i),g=await this.spawnWindow(`${e}, sample ${s+1}`,o,t+30,n+90);o.loading(),a.push(g),r.push(o)}else r[s].setImage(h),a[s].setName(`${e}, ${g} elapsed, sample ${s+1}`)}if(h)for(let i in a)a[i].setName(`${e} complete in ${g}, sample ${i+1}`),r[i].doneLoading()}),(()=>s=!0)),await waitFor((()=>!0===s))}}export{InvocationController};
